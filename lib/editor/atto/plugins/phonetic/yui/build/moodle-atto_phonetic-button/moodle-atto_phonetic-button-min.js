YUI.add("moodle-atto_phonetic-button",function(e,t){var n="atto_phonetic",r="atto_phonetic",i={PHONETIC_TEXT:"atto_phonetic_phonetic",PHONETIC_PREVIEW:"atto_phonetic_preview",PHONETIC_PREVIEW_EACH_CHAR:"atto_phonetic_preview_each_char",PHONETIC_PREVIEW_TEXTAREA:"atto_phonetic_preview_textarea",SUBMIT:"atto_phonetic_submit",LIBRARY:"atto_phonetic_library",LIBRARY_GROUPS:"atto_phonetic_groups",LIBRARY_GROUP_PREFIX:"atto_phonetic_group",LIBRARY_BASE_SYMBOL:"atto_phonetic_base_symbol"},s={LIBRARY:"."+i.LIBRARY,LIBRARY_GROUP:"."+i.LIBRARY_GROUPS+" > div > div",PHONETIC_TEXT:"."+i.PHONETIC_TEXT,PHONETIC_PREVIEW:"."+i.PHONETIC_PREVIEW,PHONETIC_PREVIEW_EACH_CHAR:"."+i.PHONETIC_PREVIEW_EACH_CHAR,SUBMIT:"."+i.SUBMIT,LIBRARY_BUTTON:"."+i.LIBRARY+" button"},o={START:"",END:""},u={FORM:'<form class="atto_form">{{{library}}}<label for="{{elementid}}_{{CSS.PHONETIC_PREVIEW}}">{{get_string "preview" component}}</label><div class="well well-small fullwidth {{CSS.PHONETIC_PREVIEW}}" ><div class="{{CSS.PHONETIC_PREVIEW_TEXTAREA}}""><textarea class="fullwidth {{CSS.PHONETIC_TEXT}}" id="{{elementid}}_{{CSS.PHONETIC_TEXT}}" rows="4"></textarea></div><div class="{{CSS.PHONETIC_PREVIEW_EACH_CHAR}}" id="{{elementid}}_{{CSS.PHONETIC_PREVIEW_EACH_CHAR}}"></div></div><div class="mdl-align"><br/><button class="{{CSS.SUBMIT}}">{{get_string "savephonetic" component}}</button></div></form>',LIBRARY:'<div class="{{CSS.LIBRARY}}"><ul>{{#each library}}<li><a href="#{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div class="{{CSS.LIBRARY_GROUPS}}">{{#each library}}<div id="{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"><div role="toolbar" data-tex="{{get_string groupname ../component}}">{{#split-phonetic "\n" elements}}<button tabindex="-1" data-tex="{{this}}" aria-label="{{this}}" title="{{this}}" >{{this}}</button>{{/split-phonetic}}</div>{{#if-phonetic groupname "librarygroup6"}}<div><label class="atto_phonetic_base_symbol">Base Symbol</label>&nbsp;<input size="1" type="text" id="combinatory_input" maxlength="1"/></div>{{/if-phonetic}}</div>{{/each}}</div></div>'};e.namespace("M.atto_phonetic").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_groupFocus:null,_phoneticPatterns:[/\\\[([\S\s]+?)\\\]/],initializer:function(){this._groupFocus={},this.get("texfilteractive")&&(this.addButton({icon:"phonetic",iconComponent:n,callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){var t=M.util.image_url("phonetic",n);this._resolvePhonetic()?(this.highlightButtons(),t=M.util.image_url("phonetic-highlight",n)):this.unHighlightButtons();var r=e.one(".atto_phonetic_button .icon");r&&r.setAttribute("src",t)},this),this.editor.all("tex").each(function(t){var n=e.Node.create('<span class="wacka_wacka_ding_dong">'+t.get("text")+"</span>");t.replace(n)}))},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var t=this._resolvePhonetic(),r=this.getDialogue({headerContent:M.util.get_string("pluginname",n),focusAfterHide:!0,width:600,focusOnShowSelector:s.PHONETIC_TEXT}),i=this._getDialogueContent();r.set("bodyContent",i);var o=i.one(s.LIBRARY),u=new e.TabView({srcNode:o});u.render(),r.show(),require(["core/event"],function(e){e.notifyFilterContentUpdated(r.get("boundingBox").getDOMNode())}),t&&i.one(s.PHONETIC_TEXT).set("text",t)},_resolvePhonetic:function(){var t=this.get("host").getSelectionParentNode(),n=this.get("host").getSelection(),r,i=!1;return this.get("host").isActive()?t?!n||n.length===0?!1:(this.sourcePhonetic=null,n=n[0],r=e.one(t).get("text"),e.Array.find(this._phoneticPatterns,function(t){var s=r.match(new RegExp(t.source,"g"));if(s&&s.length)return e.Array.find(s,function(e){var s=0;while(r.indexOf(e,s)!==-1){var o=r.indexOf(e,s),u=o+e.length,a=n.startOffset>=o&&n.startOffset<u,f=n.endOffset<=u&&n.endOffset>o;if(a&&f){var l=e.match(t);if(l&&l.length){var c=r.indexOf(l[1],o),h=c+l[1].length;return i=l[1],this.sourcePhonetic={startOuterPosition:o,endOuterPosition:u,outerMatch:e,startInnerPosition:c,endInnerPosition:h,innerMatch:l},!0}}s=u}},this)},this),i!==!1&&(i=i.trim()),i):!1:!1},_setPhonetic:function(t){var n,r,i,s,o,u;o=this.get("host"),t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),n=t.currentTarget.ancestor(".atto_form").one("textarea"),s=n.get("value"),s!==""&&(o.setSelection(this._currentSelection),this.sourcePhonetic?(r=e.one(o.getSelectionParentNode()),i=r.get("text"),u=i.slice(0,this.sourcePhonetic.startInnerPosition)+s+i.slice(this.sourcePhonetic.endInnerPosition),r.set("text",u)):o.insertContentAtFocusPoint(s),this.markUpdated())},_throttle:function(e,t){var n=null;return function(){var r=this,i=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(r,i)},t)}},_loadPreview:function(e){var t=e.currentTarget.getAttribute("data-tex"),n=e.currentTarget.get("parentNode").getAttribute("data-tex");n=="Combining"&&(t=t.substring(1,t.length)),e.preventDefault();var r=this._content.one(s.PHONETIC_PREVIEW_EACH_CHAR);r.setHTML(t)},_getDialogueContent:function(){var t=this._getLibraryContent(),r=e.Handlebars.compile(u.FORM);return this._content=e.Node.create(r({elementid:this.get("host").get("elementid"),component:n,library:t,texdocsurl:this.get("texdocsurl"),CSS:i})),this._content.all(s.LIBRARY_GROUP).each(function(e){this._setGroupTabFocus(e,e.one("button")),e.all("button a").setAttribute("tabindex","-1")},this),this._content.delegate("key",this._groupNavigation,"down:37,39",s.LIBRARY_BUTTON,this),this._content.one(s.SUBMIT).on("click",this._setPhonetic,this),this._content.delegate("click",this._selectLibraryItem,s.LIBRARY_BUTTON,this),this._content.delegate("mouseenter",this._loadPreview,s.LIBRARY_BUTTON,this),this._content},_groupNavigation:function(e){e.preventDefault();var t=e.currentTarget,n=t.get("parentNode"),r=n.all("button"),i=e.keyCode!==37?1:-1,s=r.indexOf(t
),o;s<0&&(s=0),s+=i,s<0?s=r.size()-1:s>=r.size()&&(s=0),o=r.item(s),this._setGroupTabFocus(n,o),o.focus()},_setGroupTabFocus:function(e,t){var n=e.generateID();typeof this._groupFocus[n]!="undefined"&&this._groupFocus[n].setAttribute("tabindex","-1"),t!==null&&(this._groupFocus[n]=t,t.setAttribute("tabindex",0),e.setAttribute("aria-activedescendant",t.generateID()))},_selectLibraryItem:function(e){var t=e.currentTarget.getAttribute("data-tex"),n=0,r=e.currentTarget.get("parentNode").getAttribute("data-tex");e.preventDefault(),this._setGroupTabFocus(e.currentTarget.get("parentNode"),e.currentTarget);var i=this._content.one(s.PHONETIC_PREVIEW_EACH_CHAR),o=e.currentTarget.ancestor(".atto_form").one("textarea"),u=o.get("value"),a="";if(r=="Combining"){t=t.substring(1,t.length),i.setHTML(t);var f=document.getElementById("combinatory_input").value;f!=""&&(t=f+t),a=u+t}else i.setHTML(t),a=u+t;o.set("value",a),o.focus(),n=a.length;var l=o.getDOMNode();if(typeof l.selectionStart=="number")l.selectionStart=l.selectionEnd=n;else if(typeof l.createTextRange!="undefined"){var c=l.createTextRange();c.moveToPoint(n),c.select()}},_getLibraryContent:function(){var t=e.Handlebars.compile(u.LIBRARY),r=this.get("library"),s="";return e.Handlebars.registerHelper("split-phonetic",function(e,t,n){var r,i,s;if(typeof e=="undefined"||typeof t=="undefined")return"";s="",r=t.trim().split(e);while(r.length>0)i=r.shift().trim(),n.data.key=="group6"&&(i="X"+i),s+=n.fn(i);return s}),e.Handlebars.registerHelper("if-phonetic",function(e,t,n){return e===t?n.fn(this):n.inverse(this)}),s=t({elementid:this.get("host").get("elementid"),component:n,library:r,CSS:i,DELIMITERS:o}),s}},{ATTRS:{texfilteractive:{value:!0},contextid:{value:null},library:{value:{}},texdocsurl:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","tabview","array-extras"]});
