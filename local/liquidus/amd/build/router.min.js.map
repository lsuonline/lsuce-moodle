{"version":3,"sources":["../src/router.js"],"names":["define","$","Log","ajax","notification","self","trackers","eventDefArray","initRun","eventsLoaded","registerTracker","tracker","debug","trackerInfo","trackerId","identify","trackPage","heartBeat","setInterval","addEventTracking","init","dfd","Deferred","whenTrue","resolve","promises","call","methodname","args","when","done","data","forEach","trackerDef","provider","fail","ex","exception","definition","eDef","testselector","length","processDefinition","edef","selector","event","on","evt","preventDefault","parentNode","i","ddef","ddefNode","find","each","index","dataNode","id","attr","name","value","type","val","text","processEvent","setTimeout","state","then","off","trigger","func","callBack","forceCallBack","maxIterations","window"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Liquidus Router module. Routes events to trackers.\n *\n * @package   local_liquidus\n * @copyright Copyright (c) 2020 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/log', 'core/ajax', 'core/notification'],\nfunction($, Log, ajax, notification) {\n\n    const self = this;\n\n    self.trackers = [];\n\n    self.eventDefArray = [];\n\n    self.initRun = false;\n\n    self.eventsLoaded = false;\n\n    self.registerTracker = function(tracker) {\n        Log.debug(`[${tracker.trackerInfo.trackerId}] Registering tracker`);\n        self.trackers[tracker.trackerInfo.trackerId] = tracker;\n\n        // Send initial tracker events.\n        tracker.identify();\n        tracker.trackPage();\n        if (tracker.heartBeat) {\n            setInterval(tracker.heartBeat, 10000); // Heart beat.\n        }\n        self.addEventTracking(tracker.trackerInfo.trackerId);\n    };\n\n    self.init = function() {\n        const dfd = $.Deferred();\n        if (self.initRun) {\n            self.whenTrue(() => {\n                return self.eventsLoaded;\n            }, () => {\n                dfd.resolve();\n            }, true);\n            return dfd;\n        }\n        self.initRun = true;\n\n        const promises = ajax.call([\n            {\n                methodname: 'local_liquidus_event_definition', args: {}\n            },\n        ]);\n\n        $.when(...promises).done(function(data) {\n            data.forEach((trackerDef) => {\n                self.eventDefArray[trackerDef.provider] = trackerDef;\n            });\n            self.eventsLoaded = true;\n            dfd.resolve();\n        }).fail(function(ex) {\n            notification.exception(ex);\n            dfd.resolve();\n        });\n\n        return dfd;\n    };\n\n    self.addEventTracking = function(trackerId) {\n        const trackerDef = self.eventDefArray[trackerId];\n        if (typeof trackerDef === 'undefined') {\n            Log.debug(`[${trackerId}] No custom events configured.`);\n            return;\n        }\n        const tracker = self.trackers[trackerId];\n        trackerDef.definition.forEach((eDef) => {\n            Log.debug(`[${trackerDef.provider}] Looking for selector: ${eDef.testselector}`);\n            if ($(eDef.testselector).length) {\n                self.processDefinition(tracker, eDef);\n            }\n        });\n    };\n\n    self.processDefinition = (tracker, edef) => {\n        const trackerId = tracker.trackerInfo.trackerId;\n        Log.debug(`[${trackerId}] Adding event handling for custom event: ${edef.selector} -> ${edef.event}`);\n        $(edef.selector).on(edef.event, function(evt) {\n            evt.preventDefault();\n\n            const parentNode = $(this);\n\n            Log.debug(`[${trackerId}] Tracking custom event: ${edef.selector} -> ${edef.event}`);\n\n            var data = {};\n\n            for (let i in edef.data) {\n                const ddef = edef.data[i];\n                Log.debug(`[${trackerId}] Looking for '${ddef.selector}' value.`);\n                const ddefNode = parentNode.find(ddef.selector);\n                if (ddefNode.length > 0) {\n                    Log.debug(`[${trackerId}] Selector '${ddef.selector}' value.`);\n                    ddefNode.each(function(index) {\n                        const dataNode = $(this);\n\n                        let id = dataNode.attr('id');\n                        if (typeof id === 'undefined') {\n                            id = dataNode.attr('name');\n                        }\n\n                        if (typeof id === 'undefined') {\n                            id = index;\n                        } else {\n                            id = index + '_' + id;\n                        }\n\n                        data[ddef.name + '_' + id] = null;\n\n                        let value;\n                        if (ddef.type === 'input') {\n                            value = dataNode.val();\n                        } else {\n                            value = dataNode.text();\n                        }\n                        if (typeof value !== 'undefined' && value !== '' && value !== null) {\n                            data[ddef.name + '_' + id] = value;\n                        }\n                    });\n                }\n\n            }\n\n            const dfd = $.Deferred();\n            tracker.processEvent(dfd, edef.name, data);\n\n            // Forcefully resolve the promise if it hasn't been already.\n            // This guarantees that the process is not stalled.\n            setTimeout(() => {\n                if (dfd.state() === 'pending') {\n                    Log.debug(`[${trackerId}] Failed to send data for: ${edef.selector} -> ${edef.event}`);\n                    dfd.resolve();\n                }\n            }, 1000);\n\n\n            dfd.then(() => {\n                Log.debug(`[${trackerId}] Processed: ${edef.selector} -> ${edef.event}, proceeding with event.`);\n                $(edef.selector).off(edef.event);\n                $(edef.selector).trigger(edef.event);\n            });\n        });\n    };\n\n    /**\n     * On function evaluating true.\n     *\n     * @param {function} func\n     * @param {function} callBack\n     * @param {boolean} forceCallBack\n     * @param {number} maxIterations\n     * @param {number} i\n     */\n    self.whenTrue = (func, callBack, forceCallBack, maxIterations, i) => {\n        maxIterations = !maxIterations ? 10 : maxIterations;\n        i = !i ? 0 : i + 1;\n        if (i > maxIterations) {\n            // Error, too long waiting for function to evaluate true.\n            if (forceCallBack) {\n                callBack();\n            }\n            return;\n        }\n        if (func()) {\n            callBack();\n        } else {\n            window.setTimeout(() => {\n                self.whenTrue(func, callBack, forceCallBack, maxIterations, i);\n            }, 200);\n        }\n    };\n\n    return {\n        'init': self.init,\n        'registerTracker': self.registerTracker\n    };\n});\n"],"file":"router.min.js"}