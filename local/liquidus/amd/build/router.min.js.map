{"version":3,"sources":["../src/router.js"],"names":["define","$","Log","ajax","notification","self","trackers","registerTracker","tracker","debug","trackerInfo","trackerId","push","identify","trackPage","heartBeat","setInterval","init","promises","call","methodname","args","done","data","addEventTracking","fail","ex","exception","eventDefArray","length","e","edef","testselector","processDefinition","selector","event","on","evt","preventDefault","d","ddef","type","name","val","trackerPromises","t","dfd","Deferred","processEvent","when","apply","then","off","trigger"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Liquidus Router module. Routes events to trackers.\n *\n * @package   local_liquidus\n * @copyright Copyright (c) 2020 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/log', 'core/ajax', 'core/notification'],\nfunction($, Log, ajax, notification) {\n\n    var self = this;\n\n    self.trackers = [];\n\n    self.registerTracker = function(tracker) {\n        Log.debug('Registering tracker ' + tracker.trackerInfo.trackerId);\n        self.trackers.push(tracker);\n\n        // Send initial tracker events.\n        tracker.identify();\n        tracker.trackPage();\n        if (tracker.heartBeat) {\n            setInterval(tracker.heartBeat, 10000); // Heart beat.\n        }\n    };\n\n    self.init = function() {\n        var promises = ajax.call([\n            {\n                methodname: 'local_liquidus_event_definition', args: {}\n            },\n        ]);\n\n        promises[0].done(function(data) {\n            self.addEventTracking(data);\n        }).fail(function(ex) {\n            notification.exception(ex);\n        });\n\n    };\n\n    self.addEventTracking = function(eventDefArray) {\n        if (!eventDefArray || eventDefArray.length === 0) {\n            return;\n        }\n\n        Log.debug('Adding event tracking for:');\n        Log.debug(eventDefArray);\n        for (var e in eventDefArray) {\n            var edef = eventDefArray[e];\n            Log.debug('Looking for selector: ' + edef.testselector);\n            if ($(edef.testselector).length) {\n                self.processDefinition(edef);\n            }\n        }\n    };\n\n    self.processDefinition = function(edef) {\n        Log.debug('Adding event handling for custom event: ' + edef.selector + ' -> ' + edef.event);\n        $(edef.selector).on(edef.event, function(evt) {\n            evt.preventDefault();\n\n            Log.debug('Tracking custom event: ' + edef.selector + ' -> ' + edef.event);\n\n            var data = {};\n\n            for (var d in edef.data) {\n                var ddef = edef.data[d];\n                Log.debug('Looking for ' + ddef.selector + 'value.');\n                if (ddef.type === 'input') {\n                    data[ddef.name] = $(ddef.selector).val();\n                }\n            }\n            Log.debug('Got these values:');\n            Log.debug(data);\n\n            var trackerPromises = [];\n            for (var t in self.trackers) {\n                var dfd = $.Deferred();\n                trackerPromises.push(dfd);\n                self.trackers[t].processEvent(dfd, edef.name, data);\n            }\n\n            $.when.apply($, trackerPromises).then(function() {\n                Log.debug('Processed all trackers, proceeding with event.');\n                $(edef.selector).off(edef.event);\n                $(edef.selector).trigger(edef.event);\n            });\n        });\n    };\n\n    return {\n        'init': self.init,\n        'registerTracker': self.registerTracker\n    };\n});\n"],"file":"router.min.js"}