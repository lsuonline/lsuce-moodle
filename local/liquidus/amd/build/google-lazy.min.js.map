{"version":3,"sources":["../src/google-lazy.js"],"names":["define","$","Log","Templates","self","tracker","addAnalyticsJS","dfd","Deferred","siteid","trackerInfo","lengthgid","length","courseId","staticShares","debug","context","startWith","count","substring","push","render","then","html","append","gtag","fail","resolve","loadTracker","identify","trackPage","plugins","Object","entries","forEach","type","value","pluginId","event_category","userRole","join","eventCategory","eventId","processEvent","metricName","data","userHash"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Loads Segment tracker.\n *\n * @package   local_liquidus\n * @copyright Copyright (c) 2020 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery','core/log', 'core/templates'],\n    function($, Log, Templates) {\n\n        var self = this;\n\n        var tracker = {};\n\n        self.addAnalyticsJS = function() {\n            var dfd = $.Deferred();\n            var siteid = tracker.trackerInfo.siteid;\n            var lengthgid = siteid.length;\n            var courseId = tracker.trackerInfo.staticShares.courseId;\n            if (typeof courseId === 'undefined') {\n                courseId = siteid[0];\n            }\n            if (!siteid) {\n                Log.debug('Liquidus is misconfigured for Google, Site ID is missing.');\n                return;\n            }\n            var context = [];\n            context['siteid'] = siteid[0];\n            context['courseId'] = courseId;\n            context['gacodes'] = [];\n            context['uacodes'] = [];\n            var startWith = '';\n            for (var count = 0; count < lengthgid; count++) {\n                startWith = siteid[count].substring(0, 2);\n                if (startWith === 'G-') {\n                    context['gacodes'].push(siteid[count]);\n                } else {\n                    context['uacodes'].push(siteid[count]);\n                }\n            }\n\n            Templates.render('local_liquidus/gtag', context).then(function (html) {\n                $('body').append(html);\n                if (typeof gtag === 'undefined') {\n                    dfd.fail();\n                    return;\n                }\n                /* global gtag */\n                self.gtag = gtag;\n                dfd.resolve();\n            });\n            return dfd;\n        };\n\n        tracker.loadTracker = function(trackerInfo) {\n            tracker.trackerInfo = trackerInfo;\n            return self.addAnalyticsJS();\n        };\n\n        tracker.identify = function() {}; // User hash is already sent in trackPage.\n\n        tracker.trackPage = function() {\n            if (tracker.trackerInfo.staticShares.plugins) {\n                const plugins = tracker.trackerInfo.staticShares.plugins;\n                Object.entries(plugins).forEach(\n                    ([type, value]) => {\n                        value.forEach(pluginId => {\n                            const eventId = type + '_' + pluginId;\n                            const eventCategory = 'pluginUsed';\n                            self.gtag('event', eventId, {\n                                event_category: eventCategory\n                            });\n                        });\n                    });\n                delete tracker.trackerInfo.staticShares.plugins;\n            }\n\n            if (tracker.trackerInfo.staticShares.userRole) {\n                const userRole = tracker.trackerInfo.staticShares.userRole;\n                self.gtag('event', userRole.join(','), {\n                    event_category: 'userRole'\n                });\n                delete tracker.trackerInfo.staticShares.userRole;\n            }\n\n            Object.entries(tracker.trackerInfo.staticShares).forEach(\n                ([eventCategory, eventId]) => {\n                    self.gtag('event', eventId, {\n                        event_category: eventCategory\n                    });\n                }\n            );\n        };\n\n        tracker.processEvent = function(dfd, metricName, data) {\n            self.gtag('event', metricName, {\n                'userHash': tracker.trackerInfo.staticShares.userHash,\n                'eventData': data,\n                'event_callback': function() {\n                    dfd.resolve();\n                }\n            });\n        };\n\n        return tracker;\n    });\n"],"file":"google-lazy.min.js"}