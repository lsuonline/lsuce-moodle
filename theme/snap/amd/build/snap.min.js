define(["jquery","core/log","theme_snap/headroom","theme_snap/util","theme_snap/personal_menu","theme_snap/cover_image","theme_snap/progressbar","core/templates","core/str","theme_snap/accessibility","theme_snap/messages"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(){var b=15,c=0,d=setInterval(function(){c+=1,c>b?clearInterval(d):0!=a("button.atto_fullscreen_button").length&&0!=a("div.editor_atto").length&&(a("button.atto_fullscreen_button").click(function(){a("div.editor_atto").css("background-color","#eee"),a("div.editor_atto").css("z-index","1")}),a("button.atto_html_button").click(function(){a("#id_introeditor").css("z-index","1")}),clearInterval(d))},2e3)}M.theme_snap=M.theme_snap||{};var m=!1;m?b.enableAll(!0):b.disableAll(!0);var n="",o="",p="",q="",r="",s=function(a){var b=a.split("?");if(b.length<2)return!1;var c=b[1];c=c.split("#")[0];for(var d=c.split("&"),e=[],f=0;f<d.length;f++){var g=d[f].split("="),h=g[0],i=g[1];e[h]=i}return e},t=function(){var b=a(".xdebug-error");if(b.length)for(var c=0;c<b.length;c++){var d=b[c],e=d.parentNode,f=a(e).prev("br");a(f).remove()}var g=a(".xdebug-error, .php-debug, .debuggingmessage");if(g.length){a(g).addClass("php-debug-footer");var h=a('<div id="footer-error-cont"><h3>'+M.util.get_string("debugerrors","theme_snap")+"</h3><hr></div>");a("#page-footer").append(h),a("#footer-error-cont").append(g),a(".php-debug-footer").after(a("<hr>")),a("#mr-nav").addClass("errors-found");var i=a('<a class="footer-error-link btn btn-danger" href="#footer-error-cont">'+M.util.get_string("problemsfound","theme_snap")+' <span class="badge">'+g.length+"</span></a>");a("#page-header").append(i)}},u=function(){return 0===a("body").attr("id").indexOf("page-course-view-")},v=function(){if(u()&&a(".block_adminblock form").each(function(){a(this).attr("action",a(this).attr("action")+"#coursetools")}),""===location.hash){var b=s(location.href);u()&&"undefined"!=typeof b.time&&(location.hash="coursetools",a(".block_calendar_month")&&d.scrollToElement(a(".block_calendar_month")));var c=["body.path-blocks-collect #notice form"],e=["bui_deleteid","bui_editid"];for(var f in e){var g=e[f];if("undefined"!=typeof b[g]){c.push("#notice form");break}}a(c.join(", ")).each(function(){var b=a(this).attr("action");b.indexOf("#")===-1&&b.indexOf("/course/view.php")>-1&&a(this).attr("action",a(this).attr("action")+"#coursetools")})}},w=function(){a(".path-mod-forum tr.discussion td.topic.starter").attr("data-cellname",M.util.get_string("forumtopic","theme_snap")),a(".path-mod-forum tr.discussion td.picture:not('.group')").attr("data-cellname",M.util.get_string("forumauthor","theme_snap")),a(".path-mod-forum tr.discussion td.picture.group").attr("data-cellname",M.util.get_string("forumpicturegroup","theme_snap")),a(".path-mod-forum tr.discussion td.replies").attr("data-cellname",M.util.get_string("forumreplies","theme_snap")),a(".path-mod-forum tr.discussion td.lastpost").attr("data-cellname",M.util.get_string("forumlastpost","theme_snap"))},x=function(a){return a=a.trim().toLowerCase()},y=function(b){var c,d=window.navigator.userAgent;(d.indexOf("MSIE ")||d.indexOf("Trident/"))&&(b=a("#toc-searchables").find("li").clone(!0));var e=a("#toc-search-input").val();if(e=x(e),0===e.length)a("#toc-search-results").html(""),a("#toc-search-input").removeClass("state-active");else{a("#toc-search-input").addClass("state-active");var f=[];for(c=0;c<b.length;c++){var g=b[c];x(a(g).text()).indexOf(e)>-1&&f.push(g)}a("#toc-search-results").html(f)}},z=function(){var b=[];a("#notice.snap-continue-cancel").length&&b.push("hascontinuecancel"),a("body").addClass(b.join(" "))},A=function(c){var d=location.hash;a(window).on("popstate hashchange",function(f){var g=location.hash;b.info("hashchange"),g!==d&&("#primary-nav"===location.hash?e.update():(a("#page, #moodle-footer, #js-snap-pm-trigger, #logo, .skiplinks").css("display",""),u()&&(b.info("show section",f.target),c.showSection()))),d=g})},B=function(){a("#snap-course-footer-recent-activity .info").each(function(){a(this).appendTo(a(this).prev())}),a("#snap-course-footer-recent-activity .head .name").each(function(){a(this).prependTo(a(this).closest(".head"))})},C=function(b,c){var d=new g.Circle(b,{color:"inherit",easing:"linear",strokeWidth:6,trailWidth:3,duration:1400,text:{value:"0"}}),e=a(b).attr("value")/100,f=n;0===e||"-"===a(b).attr("value")?d.setText("-"):(a(b).attr("value")<50&&(f=o),d.setText(c(b))),d.animate(e,{from:{color:"#999"},to:{color:f},step:function(a,b){b.path.setAttribute("stroke",a.color)}})},D=function(){a(".snap-student-dashboard-progress .js-progressbar-circle").each(function(){C(this,function(b){return a(b).attr("value")+"<small>%</small>"})}),a(".snap-student-dashboard-grade .js-progressbar-circle").each(function(){C(this,function(b){var c=a(b).attr("value"),d=a(b).attr("gradeformat");return d!=p&&d!=q&&d!=r||(c+="<small>%</small>"),c})})},E=function(){var b=[".chapters a",".section_footer a"," #toc-search-results a"];a(document).on("click",b.join(", "),function(b){var c=this.getAttribute("href");window.history&&window.history.pushState?(history.pushState(null,null,c),a(window).trigger("hashchange"),b.preventDefault()):location.hash=c});var e=document.querySelector("#mr-nav"),f=new c(e,{tolerance:5,offset:100,classes:{initial:"headroom",pinned:"headroom--pinned",unpinned:"headroom--unpinned",top:"headroom--top",notTop:"headroom--not-top"}});a(".notloggedin").length||f.init();var g=a("#toc-searchables").find("li").clone(!0);a("#course-toc").on("keyup","#toc-search-input",function(){y(g)}),a("#course-toc").on("keydown","#toc-search-input",function(b){var c=b.keyCode||b.which;9===c&&a("#toc-search-results a").last().blur(function(){a(this).off("blur"),a("#toc-search-input").val(""),a("#toc-search-results").html(""),a("#toc-search-input").removeClass("state-active")})}),a("#course-toc").on("click","#toc-search-results a",function(){a("#toc-search-input").val(""),a("#toc-search-results").html(""),a("#toc-search-input").removeClass("state-active")}),a(document).on("click",function(b){a(b.target).closest("#toc-search-input").length||(a("#toc-search-input").val(""),a("#toc-search-results").html(""),a("#toc-search-input").removeClass("state-active"))}),a(document).on("click","#admin-menu-trigger, #toc-mobile-menu-toggle",function(b){var c=this.getAttribute("href");"admin-menu-trigger"===this.getAttribute("id")&&(a(this).toggleClass("active"),a("#page").toggleClass("offcanvas")),a(c).attr("tabindex","0"),a(c).toggleClass("state-visible").focus(),b.preventDefault(),0===a(".message-app.main").length&&document.dispatchEvent(new Event("messages-drawer:toggle"))}),a(document).on("click","#course-toc.state-visible a",function(){a("#course-toc").removeClass("state-visible")}),a(document).on("click",".news-article .toggle",function(b){var c=a(this).closest(".news-article");d.scrollToElement(c),a(".news-article").not(c).removeClass("state-expanded"),a(".news-article-message").css("display","none"),c.toggleClass("state-expanded"),a(".state-expanded").find(".news-article-message").slideDown("fast",function(){c.is(".state-expanded")?(c.find(".news-article-message").focus(),c.attr("aria-expanded","true")):(c.focus(),c.attr("aria-expanded","false")),a(document).trigger("snapContentRevealed")}),b.preventDefault()}),a(function(){var b=!1;"ontouchstart"in window?b=!0:window.navigator.msPointerEnabled&&(b=!0),b||a('[data-toggle="tooltip"]').tooltip()})};return{snapInit:function(b,c,d,g,m,u,x,y,C,F){n=C.success,o=C.warning,p=F.gradepercentage,q=F.gradepercentagereal,r=F.gradepercentageletter,M.cfg.context=b.contextid,M.snapTheme={forcePassChange:g},e.init(x),c&&require(["theme_snap/course-lazy"],function(a){var c=new a(b);A(c)}),a(document).ready(function(){t(),w(),E(),v(),z(),a("#page-mod-assign-view #page-content").append(a("#moodle-blocks")),a(".snap-resource-long .contentafterlink .snap-resource-card-fadeout").each(function(){a(this).appendTo(a(this).prevAll(".snap-resource-long .contentafterlink .no-overflow"))}),a(".snap-header-card .snap-header-card-icons .disabled-snap-asset-completion-tracking").remove();var c=a("li.snap-activity.modtype_folder");if(a.each(c,function(b,c){var d=a(c).find("div.contentwithoutlink div.snap-assettype");if(d.length>0&&0==a(c).find("div.activityinstance div.snap-header-card .asset-type").length){var e=a(c).find("div.activityinstance div.snap-header-card");d.prependTo(e)}}),a('li.snap-activity.modtype_folder td[id^="ygtvcontentel"] > div > span.fp-filename').each(function(){a(this).replaceWith("<h3>"+a(this).text()+"</h3>")}),a("body").addClass("snap-js-loaded"),D(),B(),a("body").hasClass("pagelayout-course")||a("body").hasClass("pagelayout-frontpage")?f.courseImage(b.shortname,d):a("body").hasClass("pagelayout-coursecategory")&&b.categoryid&&f.categoryImage(b.categoryid,d),a("#page-admin-setting-themesettingsnap").length){var g=location.hash;g&&a('.nav-link[href="'+g+'"]').length&&(a('.nav-link[href="'+g+'"]').tab("show"),a(window).scrollTop(0))}if(a("body").hasClass("snap-pm-open")&&e.update(),a("#page-course-editsection.format-topics").length){var j=document.getElementById("id_name_customize"),k=document.getElementById("id_name_value");j.value="1",j.checked=!0,k.required="required",a(k).attr("pattern","\\S(.*\\S)?"),a(j).parent().css("display","none"),a("#id_cancel").on("click",function(){return a(k).removeAttr("required"),a(k).removeAttr("pattern"),!0})}else a("#id_name_value").attr("pattern","(.|\\s)*\\S(.|\\s)*"),a("#id_cancel").on("click",function(){return a(k).removeAttr("pattern"),!0});if(a('#page-mod-book-view a[href*="mod/book/tool/print/index.php"]').length){var n=s(location.href);n&&a('[data-block="_fake"]').append('<p><hr><a target="_blank" href="/mod/book/tool/print/index.php?id='+n.id+'">'+M.util.get_string("printbook","booktool_print")+"</a></p>")}var o=/^page-mod-.*-mod$/,p=o.test(a("body").attr("id"))&&location.href.indexOf("modedit")>-1;p||(o=/^page-mod-.*-general$/,p=o.test(a("body").attr("id"))&&location.href.indexOf("modedit")>-1);var q="page-course-edit"===a("body").attr("id"),r="page-course-editsection"===a("body").attr("id");a("#page-mod-hvp-mod .h5p-editor-iframe").parent().css({display:"block"});var x=["page-mod-hvp-mod"],A=x.indexOf(a("body").attr("id"))===-1;if((p||q||r)&&A){var C=[":first","#page-course-edit #id_descriptionhdr","#id_contentsection","#id_general + #id_general","#id_content","#page-mod-choice-mod #id_optionhdr","#page-mod-workshop-mod #id_gradingsettings","#page-mod-choicegroup-mod #id_miscellaneoussettingshdr","#page-mod-choicegroup-mod #id_groups","#page-mod-scorm-mod #id_packagehdr"];C=C.join(),a('form[id^="mform1"] > fieldset').not(C).wrapAll('<div class="snap-form-advanced col-md-4" />'),a(".snap-form-advanced").append(a(".collapsible-actions")),a("#page-course-edit").length||a(".snap-form-advanced fieldset").addClass("collapsed");for(var F=a('form[id^="mform1"] fieldset:first'),G=a('form[id^="mform1"] fieldset:first .fcontainer'),H=a('form[id^="mform1"] > fieldset').not('form[id^="mform1"] > fieldset:first'),I=0;I<H.length;I++){var J=a(H[I]).find(".fcontainer");a(G).append(J),a(H[I]).remove()}a(F).wrap('<div class="snap-form-required col-md-8" />');var K=a('form[id^="mform1"] fieldset:first .fitem_feditor:not(.required)');if(p&&K){var L=["body#page-mod-assign-mod","body#page-mod-choice-mod","body#page-mod-turnitintool-mod","body#page-mod-workshop-mod"],N=["body#page-mod-url-mod","body#page-mod-resource-mod","body#page-mod-folder-mod","body#page-mod-imscp-mod","body#page-mod-lightboxgallery-mod","body#page-mod-scorm-mod"];0===a(L.join()).length&&(a(G).append(K),a(G).append(a("#fitem_id_showdescription"))),a(N.join()).length>0&&i.get_strings([{key:"multimediacard",component:"theme_snap"}]).done(function(b){var c=b[0],d=a("[id='id_showdescription']").closest(".form-group");a(d).append(c)})}K=a("#page-mod-resource-mod [data-fieldtype='editor']").closest(".form-group");var O=a("#page-mod-resource-mod [id='id_showdescription']").closest(".form-group");a("#page-mod-resource-mod .snap-form-advanced #id_modstandardelshdr .fcontainer").append(K),a("#page-mod-resource-mod .snap-form-advanced #id_modstandardelshdr .fcontainer").append(O);var P=a("#page-mod-assign-mod [data-fieldtype='filemanager']").closest(".form-group"),Q=a("#page-mod-assign-mod [for='id_duedate']").closest(".form-group");a("#page-mod-assign-mod .snap-form-advanced #id_modstandardelshdr .fcontainer").append(P),a("#page-mod-assign-mod .snap-form-required .fcontainer").append(Q);var R=a("#id_visible").closest(".form-group").addClass("snap-form-visibility"),S=a(R).find("label"),T=a(R).find("select");if(a(S).insertBefore(T),a(S).text(M.util.get_string("visibility","theme_snap")+" "),a("#page-course-edit").length){var U="";(function(){return i.get_strings([{key:"showallsectionsdisabled",component:"theme_snap"},{key:"disabled",component:"theme_snap"}])})().then(function(a){var b=a[0];return U=a[1],h.render("theme_snap/form_alert",{type:"warning",classes:"",message:b})}).then(function(b){var c=a('[name="coursedisplay"] > option[value="0"]'),d=a('[name="coursedisplay"] > option[value="1"]'),e=a('[name="coursedisplay"]');c.attr("disabled","disabled"),c.append(" ("+U+")"),c.removeAttr("selected"),d.attr("selected","selected"),e.parent().append(b)})}a(".snap-form-advanced").prepend(R);var V=a('form[id^="mform1"] > .form-group:last');a(F).append(V);var W=a(".form-group.has-danger");p&&W.length&&W.closest(".collapsible").removeClass("collapsed"),a("#page-mod-page-mod").length&&function(){return i.get_strings([{key:"showappearancedisabled",component:"theme_snap"}])}().then(function(a){return h.render("theme_snap/form_alert",{type:"warning",classes:"",message:a})}).then(function(b){var c="#f1f1f1",d="#d5d5d5",e=a('[id="id_printheading"], [id="id_printintro"], [id="id_printlastmodified"]');e.attr("readonly",!0),e.attr("tabindex",-1),e.click(function(a){return a.preventDefault(),!1}),e.parent().parent().parent().css("background-color",c),e.parent().parent().parent().css("color",d);var f=a('[id="id_error_printheading"]');f.parent().parent().parent().append(b)})}m&&require(["theme_snap/conversation_badge_count-lazy"],function(a){a.init(u)});var X=a("#snap-coverimagecontrol label");X&&X.length&&X.keypress(function(b){13===b.which&&a("#snap-coverfiles").trigger("click")}),a(".block_settings").length||(a("#admin-menu-trigger").hide(),y&&require(["theme_snap/alternative_role_handler-lazy"],function(a){a.init(b.id)}));var Y,Z=a("ul#snap-navbar-content li:first-child a"),$=a("#moodle-page a:first"),_=a("#nav-notification-popover-container > div.popover-region-toggle.nav-link"),aa=a('.search-input-wrapper.nav-link > div[role="button"]'),ba=a("#admin-menu-trigger");Y=Z.length?Z:$,_.length&&aa.length&&ba.length&&Y.length&&require(["theme_snap/rearrange_tab_handler-lazy"],function(a){a.init([_,aa,ba,Y])}),a(".snap-settings-tab-link").on("click",function(){var b=a('a[href="'+a(this).attr("href")+'"].nav-link');b.length&&b.tab("show")}),"#course-detail-title"===window.location.hash&&a("#mr-nav").removeClass("headroom--pinned").addClass("headroom--unpinned"),l()}),j.snapAxInit(),k.init()}}});