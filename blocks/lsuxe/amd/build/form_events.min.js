/**
 * Cross Enrollment Tool
 *
 * @copyright 2008 onwards Louisiana State University
 * @copyright 2008 onwards David Lowe, Robert Russo
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_lsuxe/form_events",["jquery","block_lsuxe/xe_lib","block_lsuxe/notifications"],(function($,XELib,Noti){return{getTokenReady:function(){var url=$("#id_available_moodle_instances option:selected").text();XELib.getTokenForURL(url).then((function(response){1==response.success?(sessionStorage.setItem("currentToken",response.data),sessionStorage.setItem("currentUrl",url)):console.log("ERROR: Failed to get the token :-( ")}))},getGroupData:function(params){return XELib.jaxyPromise({call:"get_group_data",params:params,class:"router"})},setHiddenValue:function(tag,value){$("input[name="+tag+"]").val(value)},verifySourceCourse:function(params){return XELib.jaxyPromise({call:"verify_course",params:params,class:"router"})},verifyDestCourse:function(params){var new_params={type:"GET",url:sessionStorage.getItem("currentUrl")+"/webservice/rest/server.php",data:{wstoken:sessionStorage.getItem("currentToken"),wsfunction:"core_course_get_courses_by_field",moodlewsrestformat:"json",field:"shortname",value:params.coursename}};return XELib.jaxyRemotePromise(new_params)},resetGroupList:function(){$("#id_srccoursegroupnameselect").empty(),$("#id_srccoursegroupnametext").text(),$("#id_srccoursegroupnameselect").append($("<option></option>").attr("value",0).text("Please search for a course first"))},registerMoodleEvents:function(){$("#id_verifysource").on("click",(function(){var params={type:"GET",url:$("#id_instanceurl").val()+"/webservice/rest/server.php",data:{wstoken:$("#id_instancetoken").val(),wsfunction:"block_lsuxe_xeajax",moodlewsrestformat:"json",datachunk:JSON.stringify({call:"test_service",params:{test:"test"},class:"router"})}};XELib.testWebServices(params).then((function(response){0==response.success?Noti.callNoti({message:response.msg,type:"error"}):Noti.callNoti({message:"Successfully said hello to the remote Moodle instance .",type:"success"})}))}))},registerMappingEvents:function(){var that=this,src_form_select=$("#id_srccourseshortname");src_form_select.change((function(){src_form_select.val()?that.getGroupData({courseid:src_form_select.val(),coursename:$("#id_srccourseshortname option:selected").text()}).then((function(response){if(0==response.count)that.resetGroupList();else{$("#id_srccoursegroupnameselect").empty();var first_choice="";for(let i in response.data)""==first_choice&&(first_choice={groupid:response.data[i].groupid,groupname:response.data[i].groupname}),$("#id_srccoursegroupnameselect").append($("<option></option>").attr("value",response.data[i].groupid).text(response.data[i].groupname));that.setHiddenValue("srccoursegroupname",first_choice.groupname),that.setHiddenValue("srccoursegroupid",first_choice.groupid)}})):that.resetGroupList()})),$("#id_srccoursegroupnameselect").change((function(){var new_value=$(this).find("option:selected").attr("value"),new_text=$(this).find("option:selected").text();that.setHiddenValue("srccoursegroupname",new_text),that.setHiddenValue("srccoursegroupid",new_value)})),$("#id_verifysource").on("click",(function(){var coursename="",groupname="";"1"==sessionStorage.getItem("xes_autocomplete")?(coursename=$("#id_srccourseshortname").find("option:selected").text(),groupname=$("#id_srccoursegroupnameselect").find("option:selected").text()):(coursename=$("#id_srccourseshortname").val(),groupname=$("#id_srccoursegroupname").val()),coursename.length<1?Noti.callNoti({message:"Ooops, you forgot to enter a course short name",type:"error"}):groupname.length<1?Noti.callNoti({message:"Ooops, you forgot to enter a group name",type:"error"}):that.verifySourceCourse({coursename:coursename,groupname:groupname}).then((function(response){0==response.success?Noti.callNoti({message:response.msg,type:"error"}):(that.setHiddenValue("srccourseid",response.data.id),that.setHiddenValue("srccoursegroupid",response.data.groupid),Noti.callNoti({message:"Everything checks out for the source course and group.",type:"success"}))}))})),$("#id_verifydest").on("click",(function(){var destname=$("#id_destcourseshortname").val();that.verifyDestCourse({coursename:destname}).then((function(response){"courses"in response?1==response.courses.length?(that.setHiddenValue("destcourseid",response.courses[0].id),Noti.callNoti({message:"Destination course is there and waiting for you.",type:"success"})):Noti.callNoti({message:"There seems to be more than one course with that shortname.",type:"warn"}):Noti.callNoti({message:"The course: "+destname+" was not found on the destination server.",type:"error"})}))})),$("select#id_available_moodle_instances").on("change",(function(){that.getTokenReady(),$("div.xe_dest_course_auto ul.form-autocomplete-suggestions").empty(),$("div.xe_dest_course_auto input").val(""),$("span.notifications").empty()}))},registerEvents:function(){"mappings"==sessionStorage.getItem("xe_form")&&"true"==sessionStorage.getItem("xe_viewform")?this.registerMappingEvents():"moodles"==sessionStorage.getItem("xe_form")&&"true"==sessionStorage.getItem("xe_viewform")&&this.registerMoodleEvents()},init:function(){this.registerEvents(),this.getTokenReady()}}}));

//# sourceMappingURL=form_events.min.js.map